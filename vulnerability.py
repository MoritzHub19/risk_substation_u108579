"""
Author: Moritz Staaden
Datum: 05.01.2026

This script is used to determine the health index per substation, which is equivalent to vulnerability.
Vulnerability represents another parameter of the risk index,
in this research, aims to ensure functionality during heavy rainfall events. 
This represents the robustness against water ingress.
It is normalized using fuzzy logic.
Data from Syna GmbH is used as a basis, which is based on the assessment of technical personnel.
Three criteria are used: 
1. The condition is divided into four linguistic categories.
    - sehr_gut, gut, schlecht, sehr_schlecht
2. Signs of aging are divided into four linguistic categories.
    sehr_gut, gut, schlecht, sehr_schlecht
3. The material is divided into three linguistic categories.
    - gut, mittel, schlecht
The result in the form of the Health Index is divided into three linguistic categories.
"""

from pathlib import Path
import numpy as np
import pandas as pd
import skfuzzy as fuzz
from skfuzzy import control as ctrl


def implement_fuzzy_logic():
    """
    Creates the fuzzy logic system with input and output variables
    and the trapezoidal membership functions. Like it was made here:
    https://scikit-fuzzy.readthedocs.io/en/latest/api/skfuzzy.html
    """
    
    # Define input variables
    condition = ctrl.Antecedent(np.arange(0, 1.01, 0.01), 'condition')
    aging = ctrl.Antecedent(np.arange(0, 1.01, 0.01), 'aging')
    material = ctrl.Antecedent(np.arange(0, 1.01, 0.01), 'material')
    
    # Define output variable
    HI = ctrl.Consequent(np.arange(0, 1.01, 0.01), 'HI')
    
    # Trapezoidal membership functions for condition
    condition['sehr_gut'] = fuzz.trapmf(condition.universe, [0, 0, 0.1, 0.25])
    condition['gut'] = fuzz.trapmf(condition.universe, [0.15, 0.25, 0.45, 0.55])
    condition['schlecht'] = fuzz.trapmf(condition.universe, [0.45, 0.55, 0.75, 0.85])
    condition['sehr_schlecht'] = fuzz.trapmf(condition.universe, [0.75, 0.85, 1, 1])
    
    # Trapezoidal membership functions for aging
    aging['sehr_neu'] = fuzz.trapmf(aging.universe, [0, 0, 0.1, 0.25])
    aging['neu'] = fuzz.trapmf(aging.universe, [0.15, 0.25, 0.45, 0.55])
    aging['alt'] = fuzz.trapmf(aging.universe, [0.45, 0.55, 0.75, 0.85])
    aging['sehr_alt'] = fuzz.trapmf(aging.universe, [0.75, 0.85, 1, 1])
    
    # Trapezoidal membership functions for material
    material['gut'] = fuzz.trapmf(material.universe, [0, 0, 0.2, 0.35])
    material['mittel'] = fuzz.trapmf(material.universe, [0.25, 0.4, 0.6, 0.75])
    material['schlecht'] = fuzz.trapmf(material.universe, [0.65, 0.8, 1, 1])
    
    # Trapezoidal membership functions for vulnerability (HI)
    HI['niedrig'] = fuzz.trapmf(HI.universe, [0, 0, 0.2, 0.4])
    HI['mittel'] = fuzz.trapmf(HI.universe, [0.3, 0.4, 0.6, 0.7])
    HI['hoch'] = fuzz.trapmf(HI.universe, [0.6, 0.7, 1, 1])
    
    return condition, aging, material, HI


def create_fuzzy_rules(condition, aging, material, HI):
    """
    Creates optimized fuzzy rules with systematic logic:
    1. Condition has highest priority
    2. Material and age modify the risk 
    """
    
    rules = []
    
    # Poor condition -> always high risk
    rules.append(ctrl.Rule(condition['sehr_schlecht'], HI['hoch']))
    rules.append(ctrl.Rule(condition['schlecht'], HI['hoch']))
    
    # Very good condition -> low, except very old
    rules.append(ctrl.Rule(condition['sehr_gut'] & ~aging['sehr_alt'], HI['niedrig']))
    rules.append(ctrl.Rule(condition['sehr_gut'] & aging['sehr_alt'], HI['mittel']))
    
    # Poor material -> increases risk
    rules.append(ctrl.Rule(condition['gut'] & material['schlecht'] & (aging['alt'] | aging['sehr_alt']), HI['mittel']))
    rules.append(ctrl.Rule(condition['gut'] & material['schlecht'] & (aging['neu'] | aging['sehr_neu']), HI['niedrig']))
    
    # Medium/Good material -> mostly low, only very old -> medium  
    rules.append(ctrl.Rule(condition['gut'] & (material['mittel'] | material['gut']) & aging['sehr_alt'], HI['mittel']))
    rules.append(ctrl.Rule(condition['gut'] & (material['mittel'] | material['gut']) & ~aging['sehr_alt'], HI['niedrig']))
    
    return rules

# This function was generated with the support of Claude Sonnet 4.5, January 2026.
# Input: Write a function that converts linguistic inputs into normalized numerical values [0, 1].
# Partially adopted and adapted edition.
def linguistic_to_numeric(value, label_to_numeric):
    """
    Converts linguistic inputs to normalized numeric values [0, 1].
    """
    if pd.isna(value):
        return 0

    value_str = str(value).strip().lower()
    if value_str in label_to_numeric:
        return float(label_to_numeric[value_str])

# This function was generated with the support of Claude Sonnet 4.5, January 2026.
# Input: Write a function that calculates the HI for the three inputs using fuzzy logic. If there are errors, return None.
# Partially adopted and adapted edition.
def calculate_risk_fuzzy(condition_val, aging_val, material_val, fuzzy_system):
    """
    Calculates the HI for a single dataset using fuzzy logic.
    """
    try:
        # Set input values
        fuzzy_system.input['condition'] = condition_val
        fuzzy_system.input['aging'] = aging_val
        fuzzy_system.input['material'] = material_val
        
        # Perform fuzzy inference
        fuzzy_system.compute()
        
        # Return result
        return fuzzy_system.output['HI']
    
    except Exception as e:
        print(f"Error in fuzzy calculation: {e}")
        return None


def do():
    """
    Do function: Loads the Excel file with the criteria, calculates the HI and saves the result.
    """
    
    # Path to CSV file
    input_path = Path(r"c:\Untersuchungsgebiet\Vulnerability.csv")
    
    # Load semicolon-separated CSV
    df = pd.read_csv(input_path, sep=';', encoding='utf-8-sig')
    
    # Create fuzzy system
    print("Creating fuzzy logic system...")
    condition, aging, material, HI = implement_fuzzy_logic()
    rules = create_fuzzy_rules(condition, aging, material, HI)
    
    # Manage fuzzy control system
    # https://scikit-fuzzy.readthedocs.io/en/latest/api/skfuzzy.control.html?highlight=controlsystemsimulation#skfuzzy.control.ControlSystem
    risk_ctrl = ctrl.ControlSystem(rules)

    # Calculate fuzzy simulation
    # https://scikit-fuzzy.readthedocs.io/en/latest/api/skfuzzy.control.html?highlight=controlsystemsimulation#skfuzzy.control.ControlSystemSimulation
    risk_simulation = ctrl.ControlSystemSimulation(risk_ctrl)
    
    # Convert linguistic inputs to numeric values
    print("Converting linguistic inputs...")
    condition_map = {
        'sehr_gut': 0.0,
        'gut': 0.333,
        'schlecht': 0.666,
        'sehr_schlecht': 1.0,
    }
    age_map = {
        'sehr_gut': 0.0,
        'gut': 0.333,
        'schlecht': 0.666,
        'sehr_schlecht': 1.0,
    }
    material_map = {
        'gut': 0.0,
        'mittel': 0.5,
        'schlecht': 1.0,
    }

    # Convert columns to numbers
    zustand_liste = []
    for wert in df['Zustand']:
        zustand_liste.append(linguistic_to_numeric(wert, condition_map))
    df['Zustand_Numeric'] = zustand_liste
    
    alter_liste = []
    for wert in df['Alterserscheinung']:
        alter_liste.append(linguistic_to_numeric(wert, age_map))
    df['Alterserscheinung_Numeric'] = alter_liste
    
    material_liste = []
    for wert in df['Material']:
        material_liste.append(linguistic_to_numeric(wert, material_map))
    df['Material_Numeric'] = material_liste
    
    # Empty list for the results
    HI_werte = []
    
    # Iterate over all rows
    column_length = len(df)
    for i in range(column_length):
        # Get values from the row
        zustand = df.loc[i, 'Zustand_Numeric']
        alter = df.loc[i, 'Alterserscheinung_Numeric']
        material = df.loc[i, 'Material_Numeric']
        
        # Calculate HI
        hi = calculate_risk_fuzzy(zustand, alter, material, risk_simulation)
        HI_werte.append(hi)
    
    # Add new column
    df['HI'] = HI_werte
    
    # Remove helper columns
    df = df.drop(['Zustand_Numeric', 'Alterserscheinung_Numeric', 'Material_Numeric'], axis=1)
    
    # Save result back to the original CSV
    print(f"Saving result back to {input_path.name}...")
    df.to_csv(input_path, index=False, sep=';', encoding='utf-8-sig')

    # Show statistics
    print("\nRisk distribution:")
    print(f"  Low risk (< 0.4): {(df['HI'] < 0.4).sum()} rows")
    print(f"  Medium risk (0.4-0.6): {((df['HI'] >= 0.4) & (df['HI'] <= 0.6)).sum()} rows")
    print(f"  High risk (> 0.6): {(df['HI'] > 0.6).sum()} rows")

# Execute the do function
do()